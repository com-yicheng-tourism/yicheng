<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.yicheng.tourism.mapper.ext.UserMapperExt">
    <insert id="insertBatch" parameterType="list">
        INSERT INTO t_user
        (serial_id, user_name, mail,
        nick_name, user_pwd, birthday,
        profile_pic, user_phone, user_address,
        type, ip_address,create_time,create_id,modify_time,modify_id,is_logout)
        VALUES
        <foreach collection="list" item="item" index="index" separator=",">
            (#{item.serialId,jdbcType=VARCHAR}, #{item.userName,jdbcType=VARCHAR}, #{item.mail,jdbcType=VARCHAR},
            #{item.nickName,jdbcType=VARCHAR}, #{item.userPwd,jdbcType=DECIMAL}, #{item.birthday,jdbcType=DECIMAL},
            #{item.profilePic,jdbcType=TIMESTAMP}, #{item.userPhone,jdbcType=TIMESTAMP}, #{item.userAddress,jdbcType=DECIMAL},
            #{item.type,jdbcType=DECIMAL}, #{item.ipAddress,jdbcType=TIMESTAMP}, #{item.createTime,jdbcType=TIMESTAMP}
            , #{item.createId,jdbcType=TIMESTAMP}, #{item.modifyTime,jdbcType=TIMESTAMP}, #{item.modifyId,jdbcType=TIMESTAMP}
            , #{item.isLogout,jdbcType=TIMESTAMP})
        </foreach>
    </insert>
    <sql id="Base_Column_List">
    serial_id, user_name, e_mail, nick_name, user_pwd, birthday, profile_pic, user_phone,
    user_address, is_logout
    </sql>
    <select id="qryByUserName" resultType="com.yicheng.tourism.entity.User">
        select
        <include refid="com.yicheng.tourism.mapper.UserMapper.Base_Column_List"></include>
        from t_user
        where user_name=#{c}
    </select>
    <select id="qryByMail" resultType="com.yicheng.tourism.entity.User">
        select
        <include refid="com.yicheng.tourism.mapper.UserMapper.Base_Column_List"></include>
        from t_user
        where mail=#{c}
    </select>
    <select id="qryByCondition" parameterType="com.yicheng.tourism.dto.user.req.UserQryConditionReq"
            resultMap="com.yicheng.tourism.mapper.UserMapper.BaseResultMap">
        select t1.*,t3.name roleName
        from t_user t1,t_user_role t2,t_role t3
        <include refid="qry_sql_where"></include>
    </select>
    <sql id="qry_sql_where">
        <where>
            and t1.user_name = t2.user_id and t2.role_id = t3.id
            <if test="c.keyWords != null and '' != c.keyWords">
                and (t1.user_name like concat("%",#{c.keyWords},"%")
                    or t1.mail like concat("%",#{c.keyWords},"%")
                    or t1.nick_name like concat("%",#{c.keyWords},"%")
                    or t1.user_phone like concat("%",#{c.keyWords},"%")
                    or t1.user_address like concat("%",#{c.keyWords},"%"))
            </if>
            <if test="c.type != null and '' != c.type">
                and t1.type =#{c.type}
            </if>
            <if test="c.startTime != null and '' != c.startTime">
                and t1.birthday &gt;= #{c.startTime}
            </if>
            <if test="c.endTime != null and '' != c.endTime">
                and t1.birthday &lt;= #{c.endTime}
            </if>

        </where>
    </sql>

    <update id="updateByUsername" parameterType="com.yicheng.tourism.entity.User">
        update t_user
        <set>
            <if test="c.mail != null">
                mail = #{c.mail,jdbcType=VARCHAR},
            </if>
            <if test="c.nickName != null">
                nick_name = #{c.nickName,jdbcType=VARCHAR},
            </if>
            <if test="c.userPwd != null">
                user_pwd = #{c.userPwd,jdbcType=CHAR},
            </if>
            <if test="c.birthday != null">
                birthday = #{c.birthday,jdbcType=DATE},
            </if>
            <if test="c.profilePic != null">
                profile_pic = #{c.profilePic,jdbcType=CHAR},
            </if>
            <if test="c.userPhone != null">
                user_phone = #{c.userPhone,jdbcType=VARCHAR},
            </if>
            <if test="c.userAddress != null">
                user_address = #{c.userAddress,jdbcType=VARCHAR},
            </if>
            <if test="c.type != null">
                type = #{c.type,jdbcType=CHAR},
            </if>
            <if test="c.createTime != null">
                create_time = #{c.createTime,jdbcType=TIMESTAMP},
            </if>
            <if test="c.isLogout != null">
                is_logout = #{c.isLogout,jdbcType=BIT},
            </if>
        </set>
        where user_name=#{c.userName}
    </update>

    <update id="updatePriceByUserName" parameterType="com.yicheng.tourism.dto.order.req.OrderCarReq">
        update t_user
        <set>
            <if test="c.commodityPrice != null">
                balance = balance-#{c.commodityPrice,jdbcType=DECIMAL},
            </if>
        </set>
        where user_name=#{c.userName}
    </update>

    <select id="verification" parameterType="String" resultType="Integer">
        select count(*) from t_user t1,t_user_role t2,t_nav t3,t_role_nav t4 where t1.user_name=t2.user_id
         and t2.role_id = t4.role_id and t4.nav_id=t3.id and t1.user_name=#{username} and t3.api_url=#{apiUrl}
    </select>

    <select id="homeCount" resultType="com.yicheng.tourism.dto.home.resp.HomeCountResp">
        select count(*) tenantCount
        from t_user t1
        where t1.type = 2 or t1.type =3
    </select>
</mapper>