<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8">
        <title>树形表格</title>
        <link href="https://cdn.bootcss.com/bootstrap/3.3.7/css/bootstrap.min.css" rel="stylesheet">
        <link href="https://cdn.bootcss.com/bootstrap-table/1.11.1/bootstrap-table.min.css" rel="stylesheet">
        <!-- Select2 -->
        <link rel="stylesheet" href="/plugins/select2/css/select2.min.css">
        <link rel="stylesheet" href="/plugins/select2-bootstrap4-theme/select2-bootstrap4.min.css">
        <link rel="stylesheet" href="https://cdn.bootcss.com/jquery-treegrid/0.2.0/css/jquery.treegrid.min.css">
        <link rel="stylesheet" href="/dist/css/adminlte.min.css">
        <link rel="stylesheet" href="/plugins/sweetalert2/sweetalert2.css">
        <link href="/plugins/jqGrid-5.4.0/ui.jqgrid-bootstrap.css" rel="stylesheet"/>
        <link rel="stylesheet" href="/plugins/bootstrap/js/css/bootstrap.css">
        <link rel="stylesheet" href="/plugins/fontawesome-free/css/all.min.css">
        <link rel="stylesheet" href="/plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
        <link href="/dist/css/main.css" rel="stylesheet"/>
        <!-- Tell the browser to be responsive to screen width -->
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <!-- Font Awesome -->
        <link rel="stylesheet" href="/plugins/fontawesome-free/css/fontawesome.min.css">
        <!-- Theme style -->
        <link rel="stylesheet" href="/dist/css/adminlte.css">
        <!-- sweet alert -->
        <link rel="stylesheet" href="/plugins/sweetalert2/sweetalert2.css">
        <link rel="stylesheet" href="/plugins/daterangepicker/daterangepicker.css">
        <style>
            body{padding: 20px;}
            .demo-input{padding-left: 10px; height: 38px; min-width: 262px; line-height: 38px; border: 1px solid #e6e6e6;  background-color: #fff;  border-radius: 2px;}
            .demo-footer{padding: 50px 0; color: #999; font-size: 14px;}
            .demo-footer a{padding: 0 5px; color: #01AAED;}
            .round_icon{
                width: 34px;
                height: 34px;
                display: flex;
                border-radius: 50%;
                align-items: center;
                justify-content: center;
                overflow: hidden;
                margin: auto;
                left: 50%;
                right: 50%;
                top: 50%;
                bottom: 50%;
                text-align: center;
            }
        </style>
        <style>
            ::-webkit-scrollbar {
                display: none;
            }
        </style>
    </head>

    <body>

        <div class="wrapper" style="padding-top : 3%;padding-bottom : 3%;padding-left: 1%">
            <!-- Content Wrapper. Contains page content -->
            <div style="margin-left: 0px;height: 700px;" id="content-wrapper-user" class="content-wrapper">

                <!-- Main content -->
                <div class="content">
                    <div class="row">
                        <div class="col-12">
                            <div class="card" style="font-size: 14px">
                                <div class="card-body"style="margin-top: 40px;margin-bottom: -30px;margin-left: 50px;">
                                    <div style="width: 50%;float: left;text-align: left">
                                        <h1>角色权限树</h1>
                                    </div>
                                    <div style="width: 50%;float: right;text-align: right">
                                        <button class="btn btn-block btn-info" id="assignPermission"
                                                style="display: inline-block;width: 15%; font-size: 14px;margin-right: 40px"><i class="fa fa-search"></i>&nbsp;权限配置
                                        </button>
<!--                                        <button class="btn btn-block btn-info" id="downloadByCondition"-->
<!--                                                style="display: inline-block;width: 15%;margin-right: 5%;margin-top: 0px;">-->
<!--                                            <i-->
<!--                                                    class="glyphicon glyphicon-save	"></i>&nbsp;导出-->
<!--                                        </button>-->
                                    </div>

                                </div>
                                <div class="card-body">
                                    <div class="wrapper" style="padding-top : 3%;padding-bottom : 3%;padding-left: 1%">
                                        <div class="container">

                                            <table id="table"></table>
                                            <br/>
<!--                                            <button onclick="test()">选择</button>-->
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="content">
                <!-- 模态框（Modal） -->
                <div class="modal fade" id="roleModel" tabindex="-1" role="dialog" aria-labelledby="modalEditLabel">
                    <div class="modal-dialog" role="document">
                        <div class="modal-content">
                            <div class="modal-header">
                                <h6 class="modal-title" id="modalEditTitle">用户编辑</h6>
                            </div>
                            <div class="modal-body">
                                <form id="editForm">
                                    <div class="form-group">
                                        <div class="alert alert-danger add-error-info">错误信息展示栏。</div>
                                    </div>
                                    <table class="table table-bordered">
                                        <tr>
                                            <div class="col-md-4" style="max-width: 100%">
                                                <!-- Widget: user widget style 1 -->
                                                <div class="card card-widget widget-user">
                                                    <!-- Add the bg color to the header using any of the bg-* classes -->
                                                    <div class="widget-user-header bg-info">
                                                        <!--                            <h3 class="widget-user-username">Alexander Pierce</h3>-->
                                                        <!--                            <h5 class="widget-user-desc">Founder & CEO</h5>-->
                                                    </div>
                                                    <div class="widget-user-image">
                                                        <img class="img-circle elevation-2"
                                                             src="/dist/img/user1-128x128.jpg" id="edit-user-pic"
                                                             style="margin-top: -50px" alt="User Avatar">
                                                    </div>
                                                </div>
                                                <!-- /.widget-user -->
                                            </div>
                                        </tr>
                                        <tr>
                                            <td style="width: 120px;">
                                                <label>用户账号：<span style="color: red;">*</span></label>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control select2-hidden-accessible"
                                                       id="edit_username" placeholder="用户名" disabled="disabled"
                                                       aria-hidden="true">
                                            </td>
                                        </tr>

                                        <tr>
                                            <td style="width: 120px;">
                                                <label>用户邮箱：<span style="color: red;">*</span></label>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control select2-hidden-accessible"
                                                       id="edit_mail" placeholder="邮箱" disabled="disabled"
                                                       aria-hidden="true">
                                            </td>

                                        </tr>
                                        <tr>
                                            <td style="width: 120px;">
                                                <label>昵称：</label>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control select2-hidden-accessible"
                                                       id="edit_nick_name" placeholder="昵称" aria-hidden="true">
                                            </td>

                                        </tr>
                                        <tr>
                                            <td style="width: 120px;">
                                                <label>用户身份：<span style="color: red;">*</span></label>
                                            </td>
                                            <td>
                                                <select class="form-control custom-select" id="edit_type">
                                                    <option selected="" disabled=""><font
                                                            style="vertical-align: inherit;"><font
                                                            style="vertical-align: inherit;">选择一个</font></font></option>
                                                    <option><font style="vertical-align: inherit;"><font
                                                            style="vertical-align: inherit;">管理员</font></font></option>
                                                    <option><font style="vertical-align: inherit;"><font
                                                            style="vertical-align: inherit;">租户</font></font></option>
                                                    <option selected=""><font style="vertical-align: inherit;"><font
                                                            style="vertical-align: inherit;">游客</font></font></option>
                                                </select>
                                            </td>
                                        </tr>
                                        <tr>
                                            <td style="width: 120px;">
                                                <label>生日：</label>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control select2-hidden-accessible"
                                                       id="edit_birthday" placeholder="昵称" aria-hidden="true">
                                            </td>

                                        </tr>
                                        <tr>
                                            <td style="width: 120px;">
                                                <label>地址：</label>
                                            </td>
                                            <td>
                                                <input type="text" class="form-control select2-hidden-accessible"
                                                       id="edit_address" placeholder="昵称" aria-hidden="true">
                                            </td>

                                        </tr>
                                    </table>
                                </form>
                            </div>
                            <div class="modal-footer">
                                <button type="button" class="btn btn-default" data-dismiss="modal">取消</button>
                                <button type="button" class="btn btn-primary" id="editButton">确认</button>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- /.modal -->
            </div>
            <!-- /.content-wrapper -->
            <!--      <footer class="main-footer">-->
            <!--        <strong>Copyright &copy; 2019 <a href="##">13blog.site</a>.</strong>-->
            <!--        All rights reserved.-->
            <!--        <div class="float-right d-none d-sm-inline-block">-->
            <!--          <b>Version</b> 2.0-->
            <!--        </div>-->
            <!--      </footer>-->

        </div>

    </body>
    <script src="/plugins/jquery/jquery.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap-table/1.12.1/bootstrap-table.min.js"></script>
    <script src="https://cdn.bootcss.com/bootstrap-table/1.12.0/extensions/treegrid/bootstrap-table-treegrid.js"></script>
    <script src="https://cdn.bootcss.com/jquery-treegrid/0.2.0/js/jquery.treegrid.min.js"></script>
    <script src="/plugins/select2/js/select2.full.min.js"></script>
    <script src="/plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="/plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
    <script src="/plugins/sweetalert2/sweetalert2.min.js"></script>
    <script src="/dist/js/adminlte.js"></script>
    <script type="text/javascript">
        var $table = $('#table');
        var data = new Array();
        $(function () {


            $.ajax({
                type: "GET",
                url: "/role/qryRolePermission",
                dataType: "json",
                success: function (result) {
                    data = result.data;
                    console.log("后台数据:{}", data)
                    //控制台输出一下数据
                    // console.log(JSON.stringify(data));

                    $table.bootstrapTable({
                        data: data,
                        idField: 'id',
                        dataType: 'json',
                        columns: [
                            {
                                field: 'check', checkbox: true, formatter: function (value, row, index) {
                                    if (row.check == true) {
                                        // console.log(row.serverName);
                                        //设置选中
                                        return {checked: true};
                                    }
                                }
                            },
                            {field: 'name', title: '名称'},
                            // {field: 'id', title: '编号', sortable: true, align: 'center'},
                            // {field: 'pid', title: '所属上级'},
                            // { field: 'status',  title: '状态', sortable: true,  align: 'center', formatter: 'statusFormatter'  },
                            {field: 'remark', title: '描述'},
                            // { field: 'operate', title: '操作', align: 'center', events : operateEvents, formatter: 'operateFormatter' },
                        ],

                        // bootstrap-table-treegrid.js 插件配置 -- start

                        //在哪一列展开树形
                        treeShowField: 'name',
                        //指定父id列
                        parentIdField: 'pid',

                        onResetView: function (data) {
                            //console.log('load');
                            $table.treegrid({
                                initialState: 'collapsed',// 所有节点都折叠
                                // initialState: 'expanded',// 所有节点都展开，默认展开
                                treeColumn: 1,
                                // expanderExpandedClass: 'glyphicon glyphicon-minus',  //图标样式
                                // expanderCollapsedClass: 'glyphicon glyphicon-plus',
                                onChange: function () {
                                    $table.bootstrapTable('resetWidth');
                                }
                            });

                            //只展开树形的第一级节点
                            $table.treegrid('getRootNodes').treegrid('expand');

                        },
                        onCheck: function (row) {
                            var datas = $table.bootstrapTable('getData');
                            // 勾选子类
                            selectChilds(datas, row, "id", "pid", true);

                            // 勾选父类
                            selectParentChecked(datas, row, "id", "pid")

                            // 刷新数据
                            $table.bootstrapTable('load', datas);
                        },

                        onUncheck: function (row) {
                            var datas = $table.bootstrapTable('getData');
                            selectChilds(datas, row, "id", "pid", false);
                            $table.bootstrapTable('load', datas);
                        },
                        // bootstrap-table-treetreegrid.js 插件配置 -- end
                    });
                }
            });

        });

        // 格式化按钮
        function operateFormatter(value, row, index) {
            return [
                '<button type="button" class="RoleOfadd btn-small  btn-primary" style="margin-right:15px;"><i class="fa fa-plus" ></i>&nbsp;新增</button>',
                '<button type="button" class="RoleOfedit btn-small   btn-primary" style="margin-right:15px;"><i class="fa fa-pencil-square-o" ></i>&nbsp;修改</button>',
                '<button type="button" class="RoleOfdelete btn-small   btn-primary" style="margin-right:15px;"><i class="fa fa-trash-o" ></i>&nbsp;删除</button>'
            ].join('');

        }

        // 格式化类型
        function typeFormatter(value, row, index) {
            if (value === 'menu') {
                return '菜单';
            }
            if (value === 'button') {
                return '按钮';
            }
            if (value === 'api') {
                return '接口';
            }
            return '-';
        }

        // 格式化状态
        function statusFormatter(value, row, index) {
            if (value === 1) {
                return '<span class="label label-success">正常</span>';
            } else {
                return '<span class="label label-default">锁定</span>';
            }
        }

        //初始化操作按钮的方法
        window.operateEvents = {
            'click .RoleOfadd': function (e, value, row, index) {
                add(row.id);
            },
            'click .RoleOfdelete': function (e, value, row, index) {
                del(row.id);
            },
            'click .RoleOfedit': function (e, value, row, index) {
                update(row.id);
            }
        };
    </script>
    <script>
        /**
         * 选中父项时，同时选中子项
         * @param datas 所有的数据
         * @param row 当前数据
         * @param id id 字段名
         * @param pid 父id字段名
         */
        function selectChilds(datas, row, id, pid, checked) {
            for (var i in datas) {
                if (datas[i][pid] == row[id]) {
                    datas[i].check = checked;
                    selectChilds(datas, datas[i], id, pid, checked);
                }
                ;
            }
        }

        function selectParentChecked(datas, row, id, pid) {
            for (var i in datas) {
                if (datas[i][id] == row[pid]) {
                    datas[i].check = true;
                    selectParentChecked(datas, datas[i], id, pid);
                }
                ;
            }
        }

        function test() {
            var selRows = $table.bootstrapTable("getSelections");
            if (selRows.length == 0) {
                alert("请至少选择一行");
                return;
            }

            var postData = "";
            $.each(selRows, function (i) {
                postData += this.id;
                if (i < selRows.length - 1) {
                    postData += "， ";
                }
            });
            alert("你选中行的 id 为：" + postData);

        }

        function add(id) {
            alert("add 方法 , id = " + id);
        }

        function del(id) {
            alert("del 方法 , id = " + id);
        }

        function update(id) {
            alert("update 方法 , id = " + id);
        }


    </script>
    <script>
        function reset() {
            //隐藏错误提示框
            $('.alert-danger').css("display", "none");
            //清空数据
            $('#password').val('');
            $('#passwordEdit').val('');
            $('#userName').val('');
            $('#userId').val(0);
        }
        $(function () {
            $('#assignPermission').click(function () {
                reset();
                $('#roleModel').modal('show');

                $.ajax({
                    type: "GET",
                    url: "role/qry",
                    dataType: "json",
                    success: function (result) {
                        let data = result.data;
                        if (data !== '' && data != null) {
                            for (var i = 0; i < data.length; i++) {
                                $('#roleName').append("<option>" + data[i].name + "</option>");

                            }
                        }
                    }
                });
            })
            // function assignPermission() {
            //     // reset();
            //
            //
            //     // var id = $('#jqGrid').jqGrid('getGridParam', 'selrow');
            //     // if (id == null) {
            //     //     return;
            //     // }
            //     // var rowData = $("#jqGrid").jqGrid('getRowData', id);
            //     // let profilePic = rowData.profilePic;
            //     // let strings = JSON.stringify(profilePic).split("\"");
            //     // let editUserPic = JSON.stringify(strings[6]).replace("\"", "").replace("\\\"", "").replace("\\", "");
            //     // $('#edit-user-pic').attr("src", editUserPic);
            //     // // $('#userId').val(id);
            //     // $('#edit_username').val(rowData.userName);
            //     // $('#edit_nick_name').val(rowData.nickName);
            //     // $('#edit_birthday').val(rowData.birthday);
            //     // $('#edit_type').val(rowData.type);
            //     // $('#edit_mail').val(rowData.mail);
            //     // $('#edit_address').val(rowData.userAddress);
            //     // $('#modalEditTitle').html('用户编辑');
            //
            // }

            //绑定modal上的保存按钮
            $('#saveButton').click(function () {
                //验证数据
                if (validObjectForAdd()) {
                    //一切正常后发送网络请求
                    //ajax
                    var userName = $("#userName").val();
                    var password = $("#password").val();
                    var data = {"userName": userName, "password": password};
                    $.ajax({
                        type: 'POST',//方法类型
                        dataType: "json",//预期服务器返回的数据类型
                        url: 'users/save',//url
                        contentType: "application/json; charset=utf-8",
                        data: JSON.stringify(data),
                        beforeSend: function (request) {
                            //设置header值
                            request.setRequestHeader("token", getCookie("token"));
                        },
                        success: function (result) {
                            console.log(result);//打印服务端返回的数据
                            checkResultCode(result.resultCode);
                            if (result.resultCode == 200) {
                                swal("保存成功", {
                                    icon: "success",
                                });
                                $('#modalAdd').modal('hide');
                                //reload
                                reload();
                            } else {
                                swal(result.message, {
                                    icon: "error",
                                });
                            }
                            ;
                        },
                        error: function () {
                            reset();
                            swal("操作失败", {
                                icon: "error",
                            });
                        }
                    });

                }
            });
        })

    </script>
</html>